name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      # Step 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Step 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4. Run tests with coverage
      - name: Run tests with coverage
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          pytest --cov=. --cov-report=xml --cov-report=term-missing
        working-directory: .

      # Step 5. Lint with flake8
      - name: Lint with flake8
        run: flake8

      # Step 6. Check formatting with black
      - name: Check formatting with black
        run: black --check .

      # Step 7. Build Docker image
      - name: Build Docker image
        run: |
          docker build -f docker/recommender.Dockerfile \
            -t ghcr.io/${{ github.repository }}/reco:${{ github.sha }} .

      # Step 8. Login to GHCR (conditional)
      - name: Login to GHCR
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          if [ -n "$GHCR_TOKEN" ]; then
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          else
            echo "⚠️ GHCR_TOKEN not set, skipping GHCR login."
          fi

      # Step 9. Push image to GHCR (conditional)
      - name: Push image to GHCR
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          if [ -n "$GHCR_TOKEN" ]; then
            docker push ghcr.io/${{ github.repository }}/reco:${{ github.sha }}
          else
            echo "⚠️ GHCR_TOKEN not set, skipping GHCR push."
          fi

      # Step 10. Deploy to Google Cloud Run (conditional)
      - name: Deploy to Google Cloud Run
        env:
          GCLOUD_SERVICE_KEY: ${{ secrets.GCLOUD_SERVICE_KEY }}
          GCLOUD_PROJECT: ${{ secrets.GCLOUD_PROJECT }}
          GCLOUD_REGION: ${{ secrets.GCLOUD_REGION }}
        run: |
          if [ -n "$GCLOUD_SERVICE_KEY" ]; then
            echo "$GCLOUD_SERVICE_KEY" | base64 --decode > key.json
            gcloud auth activate-service-account --key-file=key.json
            gcloud config set project "$GCLOUD_PROJECT"
            gcloud config set run/region "$GCLOUD_REGION"
            gcloud run deploy ml-ai-recommender \
              --image ghcr.io/${{ github.repository }}/reco:${{ github.sha }} \
              --platform managed --allow-unauthenticated
          else
            echo "⚠️ GCLOUD_SERVICE_KEY not set, skipping Cloud Run deployment."
          fi
